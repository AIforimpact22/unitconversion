<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Unit Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 32px 16px; }
    h1 { margin: 0 0 16px; font-size: 28px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 20px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    label { font-size: 12px; color: #93c5fd; display: block; margin-bottom: 6px; }
    input, select, button {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #374151;
      background: #0b1220; color: #e5e7eb;
    }
    button { cursor: pointer; border-color: #2563eb; }
    .result {
      margin-top: 16px; padding: 12px; border-radius: 8px; background: #0b1220; border: 1px dashed #334155;
    }
    .flash { margin: 12px 0; padding: 10px; border-radius: 8px; background: #7f1d1d; color: #fecaca; }
    footer { margin-top: 24px; color: #94a3b8; font-size: 12px; text-align: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Unit Converter</h1>
    <div class="card">
      {% with messages = get_flashed_messages(category_filter=['error']) %}
        {% if messages %}
          {% for m in messages %}
            <div class="flash">{{ m }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <form method="post">
        <div class="row3">
          <div>
            <label for="category">Category</label>
            <select id="category" name="category" onchange="syncUnits()">
              {% for cat in categories %}
                <option value="{{ cat }}" {{ 'selected' if cat == selected_category else '' }}>{{ cat.title() }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="from_unit">From</label>
            <select id="from_unit" name="from_unit"></select>
          </div>
          <div>
            <label for="to_unit">To</label>
            <select id="to_unit" name="to_unit"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label for="amount">Amount</label>
            <input id="amount" name="amount" type="text" placeholder="e.g. 12.5" value="{{ amount }}">
          </div>
          <div style="align-self:end">
            <button type="submit">Convert</button>
          </div>
        </div>
      </form>

      {% if result is not none %}
        <div class="result">
          <strong>Result:</strong>
          <div style="margin-top:6px">
            {{ amount }} {{ selected_from }} = {{ "{:,.6g}".format(result) }} {{ selected_to }}
          </div>
        </div>
      {% endif %}
    </div>

    <footer>
      Tip: change the category to auto-update the unit pickers.
    </footer>
  </div>

  <script>
    // Units source passed from Flask
    const unitsByCategory = {{ units_by_category|tojson }};
    const selectedCategory = "{{ selected_category }}";
    const selectedFrom = "{{ selected_from }}";
    const selectedTo = "{{ selected_to }}";

    function fillSelect(select, options, selected) {
      select.innerHTML = "";
      options.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        if (u === selected) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function syncUnits() {
      const cat = document.getElementById("category").value;
      const fromSel = document.getElementById("from_unit");
      const toSel = document.getElementById("to_unit");
      const units = unitsByCategory[cat] || [];
      fillSelect(fromSel, units, units[0] || "");
      fillSelect(toSel, units, units[1] || units[0] || "");
    }

    // First paint: set the category (already selected by server), then load units
    window.addEventListener("DOMContentLoaded", () => {
      syncUnits();
      // Then restore server-chosen units if present
      const fromSel = document.getElementById("from_unit");
      const toSel = document.getElementById("to_unit");
      if (selectedFrom) fromSel.value = selectedFrom;
      if (selectedTo) toSel.value = selectedTo;
    });
  </script>
</body>
</html>
